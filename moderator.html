<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–¥–µ—Ä–∞—Ü–∏—è ‚Äî –°—Ç–µ–Ω–∞ –ø–∞–º—è—Ç–∏</title>
  <link rel="stylesheet" href="moderator.css">
  <style>
    #loginBox { display:flex; flex-direction:column; align-items:center; margin-top:100px; }
    #moderatorContent { display:none; }
  </style>
</head>
<body>
  <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="loginBox">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="margin-bottom: 10px;">
    <button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
    <p id="error" style="color:red"></p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
  <div id="moderatorContent">
    <h1>–ú–æ–¥–µ—Ä–∞—Ü–∏—è ¬´–°—Ç–µ–Ω—ã –ø–∞–º—è—Ç–∏¬ª</h1>

    <div id="stats">
      <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤: <span id="totalCount">0</span></p>
      <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–±—É—é—â–∏—Ö –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (pending): <span id="pendingCount">0</span></p>
    </div>

    <div id="postsList"></div>

    <button id="saveBtn">üíæ –û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <script>
    // SHA-256 —Ö—ç—à
    const PASSWORD_HASH = "a67ec250865394b5648c8a6f10f8374d793f9babd6978eb013dc43c8e5d3e6e1";

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function checkPassword() {
      const input = document.getElementById("password").value;
      const hash = await sha256(input);
      if (hash === PASSWORD_HASH) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("moderatorContent").style.display = "block";
        loadPosts();
      } else {
        document.getElementById("error").textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
      }
    }

    // --- —Ç–≤–æ–π –∫–æ–¥ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ ---
    const POSTS_URL = "/api/get-posts";
    const API_URL   = "/api/update-posts";
    let postsData = [];

    async function loadPosts() {
      try {
        const res = await fetch(POSTS_URL);
        postsData = await res.json();
        renderPosts();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
      }
    }

    function truncate(str, n=15) {
      return str && str.length > n ? str.slice(0, n) + "‚Ä¶" : str;
    }

    function renderPosts() {
      const total = postsData.length;
      const pending = postsData.filter(p => !p.status || p.status === "pending").length;
      document.getElementById("totalCount").textContent = total;
      document.getElementById("pendingCount").textContent = pending;

      const container = document.getElementById("postsList");
      container.innerHTML = postsData.map((p, idx) => `
        <div class="post-card ${p.status === 'approved' ? 'approved' : 'pending'}">
          <div class="post-header">
            <div class="col"><strong>–§–ò–û:</strong> ${truncate(p.fullName || "‚Äî")}</div>
            <div class="col"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${truncate(p.title || "‚Äî")}</div>
            <div class="col"><strong>–î–æ–±–∞–≤–ª–µ–Ω:</strong> ${p.createdAt ? new Date(p.createdAt).toLocaleString() : '‚Äî'}</div>
            <div class="col"><strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω:</strong> ${p.status === 'approved' ? (p.approvedAt ? new Date(p.approvedAt).toLocaleString() : '‚Äî') : '–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω'}</div>
            <div class="col">
              <label>
                <input type="checkbox" onchange="toggleStatus(${idx})" ${p.status === 'approved' ? 'checked' : ''}>
                –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
              </label>
            </div>
            <div class="col">
              <button onclick="toggleExpand(${idx})" id="expand-btn-${idx}" class="expand-btn">‚Øà —Ä–∞—Å–∫—Ä—ã—Ç—å</button>
              <button onclick="removePost(${idx})">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="post-details" id="details-${idx}">
            <p><strong>–§–ò–û (–ø–æ–ª–Ω–æ—Å—Ç—å—é):</strong> ${p.fullName || "‚Äî"}</p>
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${p.title || "‚Äî"}</p>
            ${p.photo ? `<img src="${p.photo}" alt="–§–æ—Ç–æ" class="post-photo" onclick="enlargeImage(this)">` : ''}
            <div class="post-text">${p.text}</div>
          </div>
        </div>
      `).join("");
    }

    function toggleStatus(index) {
      if (postsData[index].status === "approved") {
        postsData[index].status = "pending";
        postsData[index].approvedAt = null;
      } else {
        postsData[index].status = "approved";
        postsData[index].approvedAt = new Date().toISOString();
      }
      renderPosts();
    }

    function toggleExpand(index) {
      const details = document.getElementById(`details-${index}`);
      const btn = document.getElementById(`expand-btn-${index}`);
      if (details.style.display === "block") {
        details.style.display = "none";
        btn.textContent = "‚Øà —Ä–∞—Å–∫—Ä—ã—Ç—å";
      } else {
        details.style.display = "block";
        btn.textContent = "‚ØÜ —Å–≤–µ—Ä–Ω—É—Ç—å";
      }
    }

    function removePost(index) {
      postsData.splice(index, 1);
      renderPosts();
    }

    function enlargeImage(img) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `<img src="${img.src}" class="modal-img">`;
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    document.getElementById("saveBtn").addEventListener("click", async () => {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(postsData)
        });
        if (res.ok) {
          alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
          loadPosts();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
      }
    });
  </script>
</body>
</html>



