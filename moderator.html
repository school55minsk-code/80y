<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–¥–µ—Ä–∞—Ü–∏—è ‚Äî –°—Ç–µ–Ω–∞ –ø–∞–º—è—Ç–∏</title>
  <link rel="stylesheet" href="moderator.css">
</head>
<body>
  <h1>–ú–æ–¥–µ—Ä–∞—Ü–∏—è ¬´–°—Ç–µ–Ω—ã –ø–∞–º—è—Ç–∏¬ª</h1>

  <div id="stats">
    <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤: <span id="totalCount">0</span></p>
    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö (pending): <span id="pendingCount">0</span></p>
  </div>

  <div id="postsList"></div>

  <button id="saveBtn">üíæ –û–±–Ω–æ–≤–∏—Ç—å</button>

  <script>
  const POSTS_URL = "/api/get-posts";
  const API_URL   = "/api/update-posts";
  let postsData = [];

  async function loadPosts() {
    try {
      const res = await fetch(POSTS_URL);
      postsData = await res.json();
      renderPosts();
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
    }
  }

    function renderPosts() {
  const total = postsData.length;
  // –µ—Å–ª–∏ —É –ø–æ—Å—Ç–∞ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ pending
  const pending = postsData.filter(p => !p.status || p.status === "pending").length;

  document.getElementById("totalCount").textContent = total;
  document.getElementById("pendingCount").textContent = pending;

  const container = document.getElementById("postsList");
  container.innerHTML = postsData.map((p, idx) => `
    <div class="post-card ${p.status === 'approved' ? 'approved' : 'pending'}">
      ${p.photo ? `<img src="${p.photo}" alt="–§–æ—Ç–æ" class="post-photo">` : ''}
      <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${p.name}</p>
      <div class="post-text"><strong>–¢–µ–∫—Å—Ç:</strong><br>${p.text}</div>
      <p><strong>–î–æ–±–∞–≤–ª–µ–Ω:</strong> ${p.createdAt ? new Date(p.createdAt).toLocaleString() : '‚Äî'}</p>
      <p><strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω:</strong> ${p.status === 'approved' ? (p.approvedAt ? new Date(p.approvedAt).toLocaleString() : '‚Äî') : '–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω'}</p>
      <label>
        <input type="checkbox" onchange="toggleStatus(${idx})" ${p.status === 'approved' ? 'checked' : ''}>
        –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
      </label>
      <button onclick="removePost(${idx})">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  `).join("");
}

  function toggleStatus(index) {
    if (postsData[index].status === "approved") {
      postsData[index].status = "pending";
      postsData[index].approvedAt = null;
    } else {
      postsData[index].status = "approved";
      postsData[index].approvedAt = new Date().toISOString();
    }
    renderPosts();
  }

  function removePost(index) {
    postsData.splice(index, 1);
    renderPosts();
  }

  document.getElementById("saveBtn").addEventListener("click", async () => {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(postsData)
      });
      if (res.ok) {
        alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        loadPosts();
      } else {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      }
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
    }
  });

  loadPosts();
  </script>
</body>
</html>

